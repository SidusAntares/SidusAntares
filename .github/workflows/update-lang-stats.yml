name: Update Language Stats (via API)

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch language stats SVG
        run: |
          mkdir -p assets
          curl -s "https://github-readme-stats.vercel.app/api/top-langs/?username=${{ github.repository_owner }}&theme=github_dark&layout=compact&card_width=495&hide_border=true" > assets/lang-stats.svg

      - name: Get current SHA (if file exists)
        id: get-sha
        run: |
          sha=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/contents/assets/lang-stats.svg" \
            | jq -r '.sha // empty')
          if [ -n "$sha" ]; then
            echo "sha=$sha" >> $GITHUB_OUTPUT
          fi

      - name: Upload SVG via GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          content=$(base64 -w 0 assets/lang-stats.svg)
          message="chore: auto-update language stats [skip ci]"
          branch="main"  # ← 改成你的默认分支名

          data=$(jq -n \
            --arg message "$message" \
            --arg content "$content" \
            --arg branch "$branch" \
            --arg sha "${{ steps.get-sha.outputs.sha }}" \
            '{
              message: $message,
              content: $content,
              branch: $branch,
              sha: ($sha // null)
            }')

          curl -X PUT \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/contents/assets/lang-stats.svg" \
            -d "$data"
